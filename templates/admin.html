<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familiada - Administrator</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Administrator Panel</h1>
        
        <div class="game-controls">
            <button id="startGame">Rozpocznij grę</button>
            <button id="nextRound">Następna runda</button>
            <button id="resetRoundPoints">Zeruj punkty rundy</button>
            <button id="resetTeamNames">Przywróć domyślne nazwy</button>
        </div>
        
        <div class="game-info">
            <div class="game-status">
                <div id="gameActiveStatus">Gra nieaktywna</div>
            </div>
            <h2>Runda: <span id="currentRound">0</span></h2>
            <div>Punkty rundy: <span id="roundPoints">0</span></div>
            <div id="currentQuestion"></div>
            <div class="answers-counter">Odpowiedzi: <span id="answersCount">0/0</span> odsłonięte</div>
        </div>
        
        <div class="teams-container">
            <div class="team" id="team1">
                <h3>Zespół 1</h3>
                <div class="team-name-display">Zespół A</div>
                <input type="text" class="team-name-edit" style="display: none;">
                <button class="edit-name">Zmień nazwę</button>
                <button class="save-name" style="display: none;">Zapisz</button>
                <div class="team-score">Punkty: 0</div>
                <div class="team-warnings">Ostrzeżenia: 0</div>
                <button class="add-warning">Dodaj ostrzeżenie</button>
                <button class="award-points">Przyznaj punkty</button>
            </div>
            
            <div class="team" id="team2">
                <h3>Team 2</h3>
                <div class="team-name-display">Zespół B</div>
                <input type="text" class="team-name-edit" style="display: none;" value="Team B">
                <button class="edit-name">Zmień nazwę</button>
                <button class="save-name" style="display: none;">Zapisz</button>
                <div class="team-score">Punkty: 0</div>
                <div class="team-warnings">Ostrzeżęnia: 0</div>
                <button class="add-warning">Dodaj ostrzeżenie</button>
                <button class="award-points">Przyznaj punkty</button>
            </div>
        </div>
        
        <div class="answers-container">
            <h2>Odpowiedzi</h2>
            <div id="answersList"></div>
        </div>
    </div>
    
    <script src="/static/script.js"></script>
    <script>
        function updateGameState(data) {
            // Update game status
            const statusElement = document.getElementById('gameActiveStatus');
            statusElement.textContent = data.game_active ? "Game is active" : "Game is not started";
            statusElement.className = data.game_active ? "active" : "";
            
            // Update round info
            document.getElementById('currentRound').textContent = data.current_round;
            document.getElementById('roundPoints').textContent = data.round_points || 0;
            
            // Update question
            if (data.current_question) {
                document.getElementById('currentQuestion').textContent = data.current_question.question;
            } else {
                document.getElementById('currentQuestion').textContent = "No question selected";
            }
            
            // Update teams
            data.teams.forEach((team, index) => {
                const teamDiv = document.getElementById(`team${index + 1}`);
                teamDiv.dataset.teamId = team.id;
                
                // Update names only if not in edit mode
                if (teamDiv.querySelector('.team-name-edit').style.display === 'none') {
                    teamDiv.querySelector('.team-name-display').textContent = team.name;
                    teamDiv.querySelector('.team-name-edit').value = team.name;
                }
                
                teamDiv.querySelector('.team-score').textContent = `Score: ${team.score}`;
                teamDiv.querySelector('.team-warnings').textContent = `Warnings: ${team.warnings}`;
            });
            
            // Update answers
            const answersList = document.getElementById('answersList');
              answersList.innerHTML = '';

              if (data.answers && data.answers.length > 0) {
                  data.answers.forEach(answer => {
                      const answerDiv = document.createElement('div');
                      answerDiv.className = `answer ${answer.revealed ? 'revealed' : 'hidden'}`;
                      answerDiv.dataset.answerId = answer.id;

                      answerDiv.innerHTML = `
                          <div class="answer-points">${answer.points}</div>
                          <div class="answer-text">${answer.answer}</div>
                          <div class="answer-status">${answer.revealed ? 'REVEALED' : 'HIDDEN'}</div>
                      `;

                      if (!answer.revealed) {
                          const revealBtn = document.createElement('button');
                          revealBtn.className = 'reveal-answer';
                          revealBtn.textContent = 'Reveal';
                          answerDiv.appendChild(revealBtn);
                      }

                      answersList.appendChild(answerDiv);
                  });
              }
            }
        function setupTeamNameEditing() {
            document.querySelectorAll('.edit-name').forEach(button => {
                button.addEventListener('click', function() {
                    const teamDiv = this.closest('.team');
                    teamDiv.querySelector('.team-name-display').style.display = 'none';
                    teamDiv.querySelector('.team-name-edit').style.display = 'block';
                    teamDiv.querySelector('.edit-name').style.display = 'none';
                    teamDiv.querySelector('.save-name').style.display = 'block';
                    teamDiv.querySelector('.team-name-edit').focus();
                });
            });

            document.querySelectorAll('.save-name').forEach(button => {
                button.addEventListener('click', function() {
                    const teamDiv = this.closest('.team');
                    const newName = teamDiv.querySelector('.team-name-edit').value;
                    const teamId = teamDiv.dataset.teamId;
                    
                    fetch('/api/update_team_name', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            team_id: teamId,
                            new_name: newName
                        })
                    }).then(handleResponse).then(() => {
                        teamDiv.querySelector('.team-name-display').textContent = newName;
                        teamDiv.querySelector('.team-name-display').style.display = 'block';
                        teamDiv.querySelector('.team-name-edit').style.display = 'none';
                        teamDiv.querySelector('.edit-name').style.display = 'block';
                        teamDiv.querySelector('.save-name').style.display = 'none';
                    });
                });
            });
        }

        function handleResponse(response) {
            return response.json().then(data => {
                if (!data.success) {
                    alert(data.error || 'Operation failed');
                }
                return data;
            });
        }
        
        // Event listeners
        document.getElementById('startGame').addEventListener('click', () => {
            fetch('/api/start_game', { method: 'POST' })
                .then(handleResponse)
                .then(fetchGameState);
        });
        
        document.getElementById('nextRound').addEventListener('click', () => {
            fetch('/api/next_round', { method: 'POST' })
                .then(handleResponse)
                .then(fetchGameState);
        });
        
        document.getElementById('resetRoundPoints').addEventListener('click', () => {
            fetch('/api/reset_round_points', { method: 'POST' })
                .then(handleResponse)
                .then(fetchGameState);
        });
        
        document.getElementById('resetTeamNames').addEventListener('click', () => {
            fetch('/api/reset_team_names', { method: 'POST' })
                .then(handleResponse)
                .then(fetchGameState);
        });
        
        // Delegated event listeners
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('reveal-answer')) {
                const answerId = e.target.closest('.answer').dataset.answerId;
                fetch('/api/reveal_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer_id: answerId })
                }).then(handleResponse).then(fetchGameState);
            }
            
            if (e.target.classList.contains('award-points')) {
                const teamId = e.target.closest('.team').dataset.teamId;
                fetch('/api/award_round_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team_id: teamId })
                }).then(handleResponse).then(fetchGameState);
            }
            
            if (e.target.classList.contains('add-warning')) {
                const teamId = e.target.closest('.team').dataset.teamId;
                fetch('/api/add_warning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team_id: teamId })
                }).then(handleResponse).then(fetchGameState);
            }
        });
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            setupTeamNameEditing();
            fetchGameState();
            setInterval(fetchGameState, 2000);
        });
    </script>
</body>
</html>